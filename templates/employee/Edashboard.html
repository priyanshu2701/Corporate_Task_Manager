<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Employee Dashboard</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/main.css') }}">

 
    <style>
   /* Container */
.stats-cards {
    display: flex;
    align-items: center;
    gap: 2rem;
    margin: 1rem 0 2rem 0;
}

.stat-card {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 1.6rem;
    min-width: 200px;
    height: 66px;
    padding: 25px 2.25rem;
    border-radius: 999px;
    background: #ffffff;
    border: 1px solid var(--gray-200);
    cursor: pointer;
    font-size: 1rem;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
    transition: all 0.25s ease;
}
/* Count */
.stat-card .value {
    background: #f1f5f9;
    padding: 0.2rem 0.55rem;
    border-radius: 999px;
}

/* Label */
.stat-card .label {
    font-weight: 600;
    
    font-size: 1.1rem;
    color: var(--text-secondary);
    font-weight: 600;
    margin-bottom: 0.1rem;
}

/* Hover */
.stat-card:hover {
    background: #f9fafb;
    box-shadow: 0 4px 10px rgba(0,0,0,0.06);
}

/* Active */
.stat-card.active {
    background: #eef2ff;
    border-color: #1d4ed8;
}

.stat-card.active .value,
.stat-card.active .label {
    color: #1d4ed8;
}

/* Status accent */
.stat-card.pending {
    border-left: 4px solid #f59e0b;
}

.stat-card.completed {
    border-left: 4px solid #10b981;
}

.stat-card.ongoing {
    border-left: 4px solid #3b82f6;
}

.stat-card.ongoingProjects{
        border-left: 4px solid #e41515ff;


}


.task-table {
    display: none;
}

.task-table.active {
    display: block;
}

      

      
      .flash-messages {
          position: fixed;
          top: 20px;
          left: 50%; /* Center horizontally */
          transform: translateX(-50%); /* Adjust for exact centering */
          z-index: 1050; /* Ensure it's above other content */
          display: flex;
          flex-direction: column; /* Stack multiple messages vertically */
          gap: 10px; /* Space between messages */
          align-items: center; /* Center items within the flex container */
          width: 100%; /* Take full width to allow centering */
          max-width: 400px; /* Limit overall width of the notification area */
      }

      .flash-messages .alert {
          min-width: 280px; /* Slightly wider */
          max-width: 90%; /* Responsive width for smaller screens */
          padding: 15px 20px;
          border-radius: 0.375rem; /* Standard Bootstrap border-radius (approx 6px) */
          box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); /* Standard Bootstrap shadow */
          opacity: 1;
          transition: opacity 0.6s ease-out, transform 0.6s ease-out; /* Smooth transition for fade out and slide */
          transform: translateY(0); /* Initial position */
      }

      /* Specific background and text colors for different alert categories (Bootstrap defaults) */
      .flash-messages .alert-success {
          color: #155724; /* Dark green text */
          background-color: #d4edda; /* Light green background */
          border-color: #c3e6cb; /* Green border */
      }
      .flash-messages .alert-danger {
          color: #721c24; /* Dark red text */
          background-color: #f8d7da; /* Light red background */
          border-color: #f5c6cb; /* Red border */
      }
      .flash-messages .alert-info {
          color: #0c5460; /* Dark blue text */
          background-color: #d1ecf1; /* Light blue background */
          border-color: #bee5eb; /* Blue border */
      }
      .flash-messages .alert-warning {
          color: #856404; /* Dark yellow text */
          background-color: #fff3cd; /* Light yellow background */
          border-color: #ffeeba; /* Yellow border */
      }


      /* When Bootstrap's .fade.show is removed and .fade is active, it should transition out */
      .flash-messages .alert.fade:not(.show) {
          opacity: 0;
          transform: translateY(-20px); /* Fade out and slightly move up */
      }

      /* Ensure the close button is styled nicely within the notification */
      .flash-messages .alert .btn-close {
          font-size: 0.9rem;
          padding: 0.5rem;
          margin: -0.5rem -0.5rem -0.5rem auto; /* Adjust position */
      }

       /* Table Styles */
      .table-responsive {
          overflow-x: auto; 
          margin-top: 20px;
      }

      .table {
          width: 100%;
          border-collapse: collapse; 
          margin-bottom: 1rem; 
          color: #212529; 
      }

      .table th,
      .table td {
          padding: 12px 15px; 
          vertical-align: middle;
          border-top: 1px solid #dee2e6; 
      }

      .table thead th {
          vertical-align: bottom;
          border-bottom: 2px solid #dee2e6; 
          background-color: #f2f5f9; 
          color: #495057; 
          font-weight: 600;
          text-align: left;
      }
      
      /* --- MODIFICATION: BOLD FIRST COLUMN --- */
      .table thead th:first-child,
      .table tbody td:first-child {
          font-weight: bold;
      }

      .table-hover tbody tr:hover {
          background-color: #f0f8ff; 
      }

      .task-heading {
    display: none;
        }
        .task-heading.active {
            display: flex; /* or block, based on your layout */
        }

        .task-card {
    background: transparent;
    border: none;
    border-radius: 0;
    box-shadow: none;
}


      
    </style>
</head>



<body>

<div class="main-content">
    {% include 'sidebar.html' %}
    
    

    <div class="header">
                {# Display Flash Messages #}
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="flash-messages">
              {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
            <!-- Header Content -->
            <div class="header-content">
                <h2>
                    <i class="fas fa-user-shield me-2"></i>
                    Welcome {{ session['user_role'] | capitalize }}, {{ session['username'] }}
                </h2>

                <!-- Today Work Button -->
              <button class="today-work-btn" onclick="openTodayWorkModal()">
    <i class="fas fa-bullseye"></i>
    <span>Today Work</span>
</button>
            </div>

        </div>


     
       <!-- Stats Cards -->
       <div class="stats-cards">
   
                
        {# Pending Tasks Button #}
        <button class="stat-card pending active" id="pendingBtn" onclick="showTable('pending')">
            <span class="value">
                {{ assigned_tasks
                    |rejectattr('status', 'equalto', 'Completed')
                    |list
                    |length if assigned_tasks else 0 }}
                </span>
            <span class="label">Pending Task</span>

        </button>

        {#Completed Tasks Button#}

        <button class="stat-card completed active" id="completedBtn" onclick="showTable('completed')">
            <span class="value">
                {{ submitted_tasks|selectattr('status', 'equalto', 'Completed')
                |list
                |length if submitted_tasks else 0 }}
            </span>
            <span class="label">Completed Task</span>
        </button>
        {# Ongoing Tasks Button #}
          <!-- <button class="stat-card ongoing active" id="ongoingBtn" onclick="showTable('ongoing')">
            <span class="value">
                {{ assigned_tasks|selectattr('status', 'equalto', 'Ongoing')
                |list
                |length if assigned_tasks else 0 }}
            </span>
            <span class="label">Ongoing Task</span>
        </button> -->

      <button class="stat-card ongoingProjects active"
        id="ongoingProjectBtn"
        onclick="showTable('ongoingProject')">
    <span class="value">
        {{ projects|length if projects else 0 }}
    </span>
    <span class="label">Assign Projects</span>
</button>


        {#<div class="stat-card in-progress">
            <div class="icon">ðŸš€</div>
            <div class="value">{{ submitted_tasks|selectattr('status', 'equalto', 'In Progress')|list|length if submitted_tasks else 0 }}</div>
            <div class="label">In Progress</div>
        </div> #}
    </div>


{#Pending Task Table#}

       <!-- Section Header -->
    <div class="section-header task-heading" id="pendingHeading">
        <i class="fas fa-spinner icon"></i>
        <h4>Pending Tasks</h4>
        <a href="{{ url_for('employee_submit_task') }}" 
        class="btn btn-primary btn-sm">
            Submit Your Task
        </a>
    </div>

<div class=" task-card card">
    <div id="pendingTable"class="card-body task-table">
        {% if assigned_tasks %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Task Name</th>
                        <th>Project</th>
                        <th>Assign Date</th>
                        <th>Due Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in assigned_tasks %}
                    {% if task.status !='Completed' %}
                    <tr>
                        <td>{{ task.task_name or 'â€”' }}</td>
                        <td>{{ task.project_name or 'N/A' }}</td>
                        <td>{{ task.date_assigned or 'â€”' }}</td>
                        <td>{{ task.due_date or 'â€”' }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
            <div class="text-center p-4">
                <p class="lead">No tasks assigned to you yet.</p>
            </div>
        {% endif %}
        </div>
    </div>
    

{#Completed Task Table#}
<div class="section-header task-heading" id="completedHeading" >
        
<i class="fas fa-spinner icon"></i>
<h4>Completed Tasks</h4>
<!-- <a href="{{ url_for('employee_submit_task') }}" 
   class="btn btn-primary btn-sm">
    Submit Your Task
</a> -->

</div>

<div class="task-card card">
    <div id="completedTable" class="card-body task-table">
        {% if submitted_tasks %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">

                <thead>
                    <tr>
                        <th>Task Name</th>
                        <th>Project</th>
                        <th>Assign Date</th>
                        <th>Due Date</th>
                        <th>Completed On</th>
                    </tr>
                </thead>

                <tbody>
                    {% for task in submitted_tasks %}
                    {% if task.status == 'Completed' %}
                    <tr>
                        <td>{{ task.task_name or 'N/A' }}</td>
                        <td>{{ task.project_name or 'N/A' }}</td>
                        <td>{{ task.date_assigned or 'â€”' }}</td>
                        <td>{{ task.due_date or 'â€”' }}</td>
                        <td>{{ task.completed_date or 'â€”' }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>

            </table>
        </div>
        {% else %}
        <div class="text-center p-4">
            <p class="lead">No completed tasks yet.</p>
        </div>
        {% endif %}
    </div>
</div>

{#Ongoing Task Table#}
<div class="section-header task-heading" id="ongoingHeading" >
        
<i class="fas fa-spinner icon"></i>
<h4>Ongoing Tasks</h4>
<a href="{{ url_for('employee_submit_task') }}" 
   class="btn btn-primary btn-sm">
    Submit Your Task
</a>

</div>

<div class="task-card card">
    <div id="ongoingTable" class="card-body task-table">
     {% if assigned_tasks %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">

                <thead>
                    <tr>
                        <th>Task Name</th>
                        <th class="font-bold">Project</th>
                        <th>Due Date</th>

                    </tr>
                </thead>

                <tbody>
                    {% for task in assigned_tasks %}
                    {% if task.status == 'Ongoing' %}
                    <tr>
                        <td>{{ task.task_name or 'General Update' }}</td>
                        <td><strong>{{ task.project_name or 'N/A' }}</strong></td>
                        <td>{{ task.due_date or 'â€”' }}</td>

                        {#<td>{{ task.completed_date or 'â€”' }}</td> #}
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>

            </table>
        </div>
        {% else %}
        <div class="text-center p-4">
            <p class="lead">No Ongoing tasks yet.</p>
        </div>
        {% endif %}
    </div>
</div>

{#Ongoing Projects#}
    <div class="section-header task-heading" id="ongoingProjectHeading">
        <i class="fas fa-spinner icon"></i>
        <h4>Assign Projects</h4>
        <!-- <button type="button" class="btn btn-primary btn-sm">Submit Your Task</button> -->
    </div>
    <div class="task-card card">
        <div id="ongoingProjectTable" class="card-body task-table">
            {% if projects %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Project Name</th>
                            <th>Description</th>
                            <th>Start Date</th>
                            <th>Due Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for project in projects %}
                        <tr class="
                            {% if project.deadline_date 
                                and project.deadline_date < today 
                                and project.status != 'Completed' %}
                                table-danger
                            {% elif project.status == 'Completed' %}
                                table-success
                            {% endif %}
                        ">
                            <td>{{ project.project_name or '-' }}</td>
                            <td>{{ project.description or 'N/A' }}</td>
                            <td>
                                {{ project.created_at.strftime('%d/%m/%Y') 
                                if project.created_at else 'â€”' }}
                            </td>
                            <td>
                                {{ project.deadline_date.strftime('%d/%m/%Y') 
                                if project.deadline_date else 'â€”' }}
                                {% if project.deadline_date 
                                    and project.deadline_date < today 
                                    and project.status != 'Completed' %}
                                    <span class="badge bg-danger ms-2">Overdue</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if project.status == 'Completed' %}
                                    <span class="badge bg-success">Completed</span>
                                {% elif project.status == 'Ongoing' %}
                                    <span class="badge bg-primary">Ongoing</span>
                                {% elif project.status == 'Pending' %}
                                    <span class="badge bg-warning text-dark">Pending</span>
                                {% elif project.status == 'Blocked' %}
                                    <span class="badge bg-danger">Blocked</span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        {{ project.status }}
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center p-4">
                <p class="lead">No projects found.</p>
            </div>
            {% endif %}
        </div>
    </div>

</div>
     <!-- Today Work Modal -->
<div id="todayWorkModal" class="modal-overlay">
    <div class="modal-box">
        <button class="modal-close" onclick="closeTodayWorkModal()">&times;</button>

        <div id="todayWorkContent">
            <div class="loading">Loading...</div>
        </div>
    </div>
</div>

<script>
    function showTable(type) {
                // Hide all tables
                document.querySelectorAll('.task-table').forEach(t => {
                    t.classList.remove('active');
                });

                // Remove active from all cards
                document.querySelectorAll('.stat-card').forEach(c => {
                    c.classList.remove('active');
                });
                //Remove active from Headings
                document.querySelectorAll('.task-heading').forEach(h=>{
                    h.classList.remove('active');
                })

                // Show selected table
                document.getElementById(type + 'Table').classList.add('active');

                //show selected Headings
                document.getElementById(type+ 'Heading').classList.add('active');

                // Activate selected card
                document.getElementById(type + 'Btn').classList.add('active');
            }
    // Automatically dismiss flash messages after 3 seconds
    document.addEventListener('DOMContentLoaded', function() {
          const flashMessages = document.querySelectorAll('.alert');
          flashMessages.forEach(function(message) {
              setTimeout(function() {
                  // Use Bootstrap's built-in alert dismissal if available
                  const bsAlert = bootstrap.Alert.getInstance(message) || new bootstrap.Alert(message);
                  bsAlert.close();
              }, 3000); // 3000 milliseconds = 3 seconds
        });
        showTable('pending');
    });
</script>

<script>
function attachTodayWorkFormHandler() {
    const form = document.getElementById('todayWorkForm');
    if (!form) return;

    form.addEventListener('submit', function(e) {
        e.preventDefault(); // stop page reload

        const workText = form.today_work.value.trim();
        const messageDiv = document.getElementById('formMessage');

        if (!workText) {
            messageDiv.innerText = "Work cannot be empty!";
            return;
        }

        fetch("{{ url_for('today_work') }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Requested-With": "XMLHttpRequest"
            },
            body: JSON.stringify({ today_work: workText })
        })
        .then(res => res.json())

           .then(data => {
            messageDiv.innerText = data.message;

            if (data.status === 'success') {
                form.reset();

                // Switch to View tab

                // Reload only the View Work section
                fetch("{{ url_for('today_work') }}")
                    .then(res => res.text())
                    .then(html => {
                        const temp = document.createElement('div');
                        temp.innerHTML = html;

                        const newViewWork = temp.querySelector('#viewWork');
                        const currentViewWork = document.querySelector('#viewWork');

                        if (newViewWork && currentViewWork) {
                            currentViewWork.innerHTML = newViewWork.innerHTML;
                        }
                    });
    }
})

        .catch(err => {
            console.error(err);
            messageDiv.innerText = "Something went wrong!";
        });
    });
}

// Call this after fetching modal content
function openTodayWorkModal() {
    const modal = document.getElementById('todayWorkModal');
    const content = document.getElementById('todayWorkContent');

    modal.style.display = 'flex';
    content.innerHTML = '<div class="loading">Loading...</div>';

    fetch("{{ url_for('today_work') }}")
        .then(res => res.text())
        .then(html => {
            const temp = document.createElement('div');
            temp.innerHTML = html;
            const workContainer = temp.querySelector('.work-container');

            content.innerHTML = '';
            content.appendChild(workContainer);

            // Attach AJAX handler after content is loaded
            attachTodayWorkFormHandler();
        });
}

function closeTodayWorkModal() {
    document.getElementById('todayWorkModal').style.display = 'none';
}
</script>


{# JS for tab switch from add work to view work #}
<script>
    function switchTab(tab) {
        document.querySelectorAll('.work-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.work-section').forEach(s => s.classList.remove('active'));

        if (tab === 'add') {
            document.querySelector('.work-tab:first-child').classList.add('active');
            document.getElementById('addWork').classList.add('active');
        } else {
            document.querySelectorAll('.work-tab').forEach(t => {
                if (t.innerText.includes('View')) t.classList.add('active');
            });
            document.getElementById('viewWork').classList.add('active');
        }
    }
</script>
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>