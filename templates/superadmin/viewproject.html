<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SuperAdmin Dashboard - View Projects</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
    />

    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='./assets/css/main.css') }}"
    />

    <style>
      /* General Body and Layout */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f8fafc;
        min-height: 100vh;
      }

      .main-content {
        display: flex; /* Enables flexbox for sidebar and main content */
        min-height: 100vh;
      }

      /* Form Container (used for project table and edit form) */
      .form-container {
        flex: 1; /* Allows the container to grow and fill available space */
        padding: 40px;
        background: white;
        margin: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }

      /* Section Titles */
      .section-title {
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e5e7eb;
      }

      .section-title h4 {
        color: #1e40af;
        font-size: 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* Smaller section title specifically for tables/edit forms */
      .form-section .section-title-small { 
          color: #1e40af; 
          font-size: 1.35rem; 
          font-weight: 600;
          margin-bottom: 25px; 
          padding-bottom: 10px;
          border-bottom: 1px solid #e5e7eb; 
          display: flex;
          align-items: center;
          gap: 10px;
      }

      /* Table Styles (Mirroring Bootstrap-like appearance) */
      .table-responsive {
          overflow-x: auto; 
          margin-top: 20px;
      }

      .table {
          width: 100%;
          border-collapse: collapse; 
          margin-bottom: 1rem; 
          color: #212529; 
      }

      .table th,
      .table td {
          padding: 12px 15px; 
          vertical-align: middle;
          border-top: 1px solid #dee2e6; 
      }

      .table thead th {
          vertical-align: bottom;
          border-bottom: 2px solid #dee2e6; 
          background-color: #f2f5f9; 
          color: #495057; 
          font-weight: 600;
          text-align: left;
      }
      
      /* --- MODIFICATION: BOLD FIRST COLUMN --- */
      .table thead th:first-child,
      .table tbody td:first-child {
          font-weight: bold;
      }

      .table-bordered th,
      .table-bordered td {
          border: 1px solid #dee2e6; 
      }

      .table-hover tbody tr:hover {
          background-color: #f0f8ff; 
      }

      /* Specific for "No projects yet" message */
      .no-tasks {
          text-align: center;
          padding: 30px;
          color: #6c757d;
          font-size: 1.1rem;
          background-color: #fdfdfd;
          border-radius: 10px;
          border: 1px dashed #e9ecef;
      }


      /* General button styles (from adduser/createproject) */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 8px 16px; 
        font-size: 0.875rem; 
        font-weight: 600;
        text-align: center;
        text-decoration: none;
        border: none;
        border-radius: 8px; 
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .btn-sm {
        padding: 6px 12px;
        font-size: 0.8rem;
      }

      .btn-warning {
        background-color: #ffc107; 
        color: #212529; 
      }

      .btn-warning:hover {
        background-color: #e0a800;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.4);
      }
      
      .btn-danger {
          background-color: #dc3545;
          color: white;
      }
      
      .btn-danger:hover {
          background-color: #c82333;
          transform: translateY(-1px);
          box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
      }

      .btn-primary { /* For Save Changes */
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
        box-shadow: 0 2px 10px rgba(37, 99, 235, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
      }

      .btn-secondary { /* For Cancel */
          background-color: #6c757d;
          color: white;
      }

      .btn-secondary:hover {
          background-color: #5a6268;
          transform: translateY(-1px);
          box-shadow: 0 2px 8px rgba(108, 117, 125, 0.4);
      }

      .form-control, .form-select { /* Added from other forms for consistency */
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
        outline: none;
      }
      
      /* --- MODIFICATION: CAPITALIZE INPUTS --- */
      .form-control {
        text-transform: capitalize;
      }

      .form-control:focus, .form-select:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .form-label { /* Added from other forms for consistency */
        display: block;
        margin-bottom: 8px;
        color: #374151;
        font-weight: 500;
        font-size: 0.9rem;
      }

      .row { /* Added from other forms for consistency */
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px; /* Adjusted from 0 to 20px */
      }

      .col-md-6 { /* Added from other forms for consistency */
        flex: 1;
        min-width: calc(50% - 10px);
      }
      .col-md-4 { /* Added from other forms for consistency */
        flex: 1;
        min-width: calc(33% - 10px);
        
      }

      .mb-3 { /* Added from other forms for consistency */
        margin-bottom: 20px;
      }

      .overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1000; /* Below sidebar, above main content */
          display: none;
      }

      .overlay.active {
          display: block;
      }

      /* PAGINATION STYLES - UPDATED */
      .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 2rem;
      }

      .pagination {
        display: flex;
        list-style: none;
        padding: 0;
        gap: 8px; /* Space between buttons */
      }

      .pagination li a {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 36px;
        height: 36px;
        text-decoration: none;
        background-color: #f3f4f6; /* Light grey background */
        color: #6b7280; /* Darker grey text */
        border-radius: 8px;
        transition: background-color 0.3s, color 0.3s;
        font-weight: 600;
        border: none; /* Remove border */
      }
      
      .pagination li a:hover {
        background-color: #e5e7eb;
      }

      .pagination li.active a {
        background-color: #4f46e5; /* Indigo/Purple background */
        color: white;
        cursor: default;
      }

      .pagination li.disabled a {
        color: #d1d5db; /* Lighter grey for disabled text/icon */
        background-color: #f3f4f6;
        pointer-events: none;
      }

      /* Animation */
      .form-container {
        animation: fadeIn 0.5s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .main-content {
          flex-direction: column; 
        }

        .sidebar { 
          width: 100%;
          height: auto;
          order: 1; 
        }

        .form-container {
          margin: 10px;
          padding: 25px 20px;
          order: 2; 
        }

        .form-section .section-title-small {
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .table th, .table td {
            padding: 8px 10px;
            font-size: 0.9rem;
        }

        .btn {
            padding: 8px 15px;
            font-size: 0.85rem;
        }

        .row {
            flex-direction: column; /* Stack columns on small screens */
            gap: 0; /* Remove gap when stacked */
        }
        .col-md-6 {
            min-width: 100%;
        }
      }
      .status-badge {
    padding: 0.35em 0.8em;
    border-radius: 50px;
    font-size: 0.78rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: 1px solid transparent;
}

.status-ongoing { background-color: #e7f5ff; color: #1c7ed6; border-color: #a5d8ff;}
.status-in-progress { background-color: #f3e8ff; color: #7048e8; border-color: #d0bfff;}
.status-pending { background-color: #fff9db; color: #f59f00; border-color: #ffec99;}
.status-completed { background-color: #e6fcf5; color: #2f9e44; border-color: #96f2d7;}
.status-blocked { background-color: #ffe3e3; color: #e03131; border-color: #ffa8a8;}
.status-filter-form {
  position: relative;
  margin-right: 15px;
}

.status-filter-select {
  border-radius: 8px;
  padding: 6px 10px;
}

    </style>
  </head>
    <body>
<div class="overlay" id="overlay"></div>
<div class="main-content" id="mainContent">
    {% include 'sidebar.html' %}
    
    {# Projects Table View #}
    <div id="allProjectsTable" class="form-container">
   
        <div class="form-section mt-5">
          <!-- Project Status Filter (Distinct Form) -->


          <h4 class="section-title-small mb-3">
            <i class="fas fa-project-diagram me-2"></i>All Projects
          </h4>
             <form name="status_filter_form" class="status-filter-form mb-3 d-flex justify-content-end" method="Get">
  <div class="d-flex align-items-center gap-2">
    <label for="status_filter" class="fw-semibold me-2">Filter by Status:</label>
    <select name="status" id="status_filter" class="form-select status-filter-select" style="width: 200px;" onchange="this.form.submit()">
      <option value="">All Projects</option>
      <option value="Ongoing" {% if request.args.get('status') == 'Ongoing' %}selected{% endif %}>Ongoing</option>
      <option value="Completed" {% if request.args.get('status') == 'Completed' %}selected{% endif %}>Completed</option>
    </select>
  </div>
</form>
          {% if projects %}
          <div class="table-responsive mt-3">
            <table class="table table-bordered table-hover">
              <thead>
                <tr>
                  <!-- MODIFICATION: Project Name is already first -->
                  <th>Project Name</th>
                  <th>Description</th>
                  <th>Project Head</th>
                  <th>Department</th>
                  <th>Start Date</th>
                  <th>Deadline Date</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="projectTableBody">
                {% for project in projects %}
                <tr class="project-row">
                  <!-- MODIFICATION: Project Name is already first -->
                  <td>{{ project.name }}</td>
                  <td>{{ project.description or '—' }}</td>
                  <td>{{ project.project_head_name or '—' }}</td>
                  <td>{{ project.department or '—' }}</td>
                  <td>{{ project.created_at }}</td>
                  <td>{{ project.deadline_date or '—' }}</td>
                  <td>
                      {% if project.status %}
                        <span class="status-badge status-{{ project.status.lower().replace(' ', '-') }}">
                          {{ project.status }}
                        </span>
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>

                  
                  <td>
                    <div class="d-flex gap-2">
                       <button class="btn btn-sm btn-warning"
                          onclick='editProject(
                              "{{ project.id }}",
                              "{{ project.name | e }}",
                              "{{ project.description | e }}",
                              "{{ project.department | e }}",
                              "{{ project.project_head_id }}",
                              "{{ project.created_at_raw }}",
                              "{{ project.deadline_date_raw }}",
                              "{{ project.status }}",
                              {{ project.member_ids_list | tojson }}
                          )'>
                          <i class="fas fa-edit"></i> Edit
                      </button>


                        <button class="btn btn-sm btn-danger" onclick="deleteProject('{{ project.id }}')">
                            <i class="fas fa-trash-alt"></i> Delete
                        </button>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <!-- PAGINATION CONTROLS -->
          <div id="pagination-wrapper" class="pagination-container">
             <ul class="pagination" id="pagination"></ul>
          </div>
          {% else %}
          <p class="text-muted mt-3 no-tasks">No projects created yet.</p>
          {% endif %}
        </div>
      </div>

    {# Edit Project Form (Initially Hidden) #}
    <div id="editProjectFormContent" class="form-container" style="display:none;">
        <div class="section-title">
          <h4>✏️ Edit Project</h4>
        </div>
        <form action="/update_project" method="POST">
          <input type="hidden" name="project_id" id="editProjectId"> {# Hidden input for project ID #}

          <div class="mb-3">
            <label class="form-label">Project Name</label>
            <input
              name="project_name"
              class="form-control"
              required
              id="editProjectName"
              placeholder="Enter project name"
            />
          </div>
          <div class="mb-3">
            <label class="form-label">Project Description</label>
            <textarea
              class="form-control"
              rows="3"
              name="description"
              id="editProjectDescription"
              placeholder="Describe the project..."
            ></textarea>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
            <label class="form-label">Project Members</label>

            <select name="project_member_ids" class="form-select" id="editprojectMembers" multiple required>
                {% for member in members %}
                    {% set is_busy = member.id|string in busy_members %}
                    <option 
                        value="{{ member.id }}"
                        data-department="{{ member.department }}"
                        class="{{ 'busy-member' if is_busy else 'free-member' }}"
                    >
                        {{ member.name }} ({{ member.role }})
                        {% if is_busy %} - Busy {% else %} - Free {% endif %}
                    </option>
                {% endfor %}
            </select>

            <small class="text-muted">Hold CTRL to select multiple members.</small>
        </div>
             
            <div class="col-md-4 mb-3">
              <label class="form-label">Department</label>
              <select name="department" class="form-select" required id="editProjectDepartment">
                <option value="">Select Department</option>
                <option value="Digital">Digital</option>
                <option value="Graphics">Graphics</option>
                <option value="Sales">Sales</option>
                <option value="Developer">Developer</option>
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Project Head (Admin Only)</label>
              <select name="project_head_id" class="form-select" required id="editProjectHead">
                <option value="">Select Project Head</option>
                {% for admin in admins %}
                <option value="{{ admin.id }}" data-department="{{ admin.department }}">{{ admin.name }} ({{ admin.email }})</option>
                {% endfor %}
              </select>
            </div>
          </div>
          
          <div class="row">

            <div class="col-md-4 mb-3">
              <label class="form-label">Status</label>
              <select name="status" class="form-select" required id="editProjectStatus">
                <option value="">Select Status</option>
                <option value="Ongoing">Ongoing</option>
                <option value="Completed">Completed</option>
                
              </select>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Start Date</label>
              <input
                name="start_date"
                type="date"
                class="form-control"
                required
                id="editProjectStartDate"
              />
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Deadline Date</label>
              <input
                name="deadline_date"
                type="date"
                class="form-control"
                required
                id="editProjectDeadlineDate"
              />
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Save Changes</button>
          <button type="button" class="btn btn-secondary" onclick="cancelProjectEdit()">Cancel</button>
        </form>
    </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
    // --- PAGINATION SCRIPT ---
    const rowsPerPage = 10;
    let projectTableBody;
    let allRows;
    let currentPage = 1;

    document.addEventListener('DOMContentLoaded', function() {

      
        // Sidebar toggle functionality
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('overlay');

        if (sidebarToggle && sidebar && overlay) {
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            });

            overlay.addEventListener('click', function() {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            });
        }
        
        const editForm = document.querySelector('#editProjectFormContent form');
        if (editForm) {
            const inputs = editForm.querySelectorAll('.form-control, .form-select');
            inputs.forEach(input => {
            input.addEventListener('blur', function() {
                if (this.value.trim() !== '') {
                this.style.borderColor = '#10b981';
                } else if (this.hasAttribute('required')) {
                this.style.borderColor = '#ef4444';
                }
            });
            input.addEventListener('focus', function() {
                this.style.borderColor = '#2563eb';
            });
            });
        }

        // --- PAGINATION SETUP ---
        projectTableBody = document.getElementById("projectTableBody");
        if (projectTableBody) {
            allRows = Array.from(projectTableBody.querySelectorAll("tr.project-row"));
            displayPage(allRows);
        }
    });

    function setupPagination(items) {
        const paginationWrapper = document.getElementById('pagination-wrapper');
        const paginationElement = document.getElementById("pagination");
        paginationElement.innerHTML = "";
        
        // MODIFICATION: Only hide pagination if there are no items at all.
        if (!paginationWrapper || items.length === 0) {
          if(paginationWrapper) paginationWrapper.style.display = 'none';
          return;
        }
        paginationWrapper.style.display = 'flex';

        const pageCount = Math.ceil(items.length / rowsPerPage);

        // Previous Button
        let prevLi = document.createElement('li');
        prevLi.innerHTML = `<a href="#" aria-label="Previous"><i class="fas fa-chevron-left"></i></a>`;
        if (currentPage === 1) prevLi.classList.add('disabled');
        prevLi.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                displayPage(items);
            }
        });
        paginationElement.appendChild(prevLi);

        // Page Number Buttons
        for (let i = 1; i <= pageCount; i++) {
            let li = document.createElement('li');
            li.innerHTML = `<a href="#">${i}</a>`;
            if (i === currentPage) {
                li.classList.add('active');
            }
            li.addEventListener('click', (e) => {
                e.preventDefault();
                currentPage = i;
                displayPage(items);
            });
            paginationElement.appendChild(li);
        }

        // Next Button
        let nextLi = document.createElement('li');
        nextLi.innerHTML = `<a href="#" aria-label="Next"><i class="fas fa-chevron-right"></i></a>`;
        if (currentPage === pageCount) nextLi.classList.add('disabled');
        nextLi.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentPage < pageCount) {
                currentPage++;
                displayPage(items);
            }
        });
        paginationElement.appendChild(nextLi);
    }

    function displayPage(items) {
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        
        // Hide all rows first
        allRows.forEach(row => row.style.display = 'none');
        
        // Show only the rows for the current page
        const paginatedItems = items.slice(start, end);
        paginatedItems.forEach(item => item.style.display = '');

        setupPagination(items);
    }

    // --- INIT EDIT MEMBERS CHOICES ---
const editMemberSelect = document.getElementById("editprojectMembers");

const editMemberChoices = new Choices(editMemberSelect, {
    removeItemButton: true,
    shouldSort: false
});

const allEditMemberOptions = Array.from(editMemberSelect.options).map(option => ({
    value: option.value,
    label: option.textContent,
    customProperties: {
        department: option.dataset.department || ""
    }
}));


// ===============================
// EDIT PROJECT FUNCTIONALITY
// ===============================
function editProject(
    id,
    name,
    description,
    department,
    projectHeadId,
    startDate,
    deadlineDate,
    status,
    memberIDs = []
) {
    // Populate basic fields
    document.getElementById('editProjectId').value = id;
    document.getElementById('editProjectName').value = name;
    document.getElementById('editProjectDescription').value = description;
    document.getElementById('editProjectDepartment').value = department;
    document.getElementById('editProjectHead').value = projectHeadId;
    document.getElementById('editProjectStartDate').value = startDate;
    document.getElementById('editProjectDeadlineDate').value = deadlineDate;
    document.getElementById('editProjectStatus').value = status;

    /* ==========================
       FILTER MEMBERS BY DEPT
    ========================== */

    const filteredMembers = allEditMemberOptions.filter(opt =>
        opt.customProperties.department === department
    );

    editMemberChoices.clearStore();
    editMemberChoices.setChoices(filteredMembers, "value", "label", true);

    // Restore existing project members (SAFE)
    (memberIDs || []).forEach(mid => {
        editMemberChoices.setChoiceByValue(String(mid));
    });

    // Show edit form
    document.getElementById('allProjectsTable').style.display = 'none';
    document.getElementById('editProjectFormContent').style.display = 'block';
}

window.editProject = editProject;

    function cancelProjectEdit() {
        // Hide the edit form and show the project table
        document.getElementById('editProjectFormContent').style.display = 'none';
        document.getElementById('allProjectsTable').style.display = 'block';
    }
    window.cancelProjectEdit = cancelProjectEdit;

    function deleteProject(projectId) {
        showConfirmationModal('Are you sure you want to delete this project? This action cannot be undone.', function() {
            fetch(`/delete_project/${projectId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    showErrorModal(data.message || 'An unknown error occurred.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showErrorModal('An error occurred while trying to delete the project.');
            });
        });
    }
    window.deleteProject = deleteProject;

    // Custom Confirmation Modal
    function showConfirmationModal(message, callback) {
        const existingModal = document.getElementById('confirmationModal');
        if (existingModal) existingModal.remove();

        const modalHtml = `
            <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Action</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">${message}</div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                        </div>
                    </div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        modal.show();
        document.getElementById('confirmDeleteBtn').onclick = () => {
            callback();
            modal.hide();
        };
        document.getElementById('confirmationModal').addEventListener('hidden.bs.modal', e => e.target.remove());
    }

    // Custom Error Modal
    function showErrorModal(message) {
        const existingModal = document.getElementById('errorModal');
        if (existingModal) existingModal.remove();

        const modalHtml = `
            <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Error</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">${message}</div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                        </div>
                    </div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const modal = new bootstrap.Modal(document.getElementById('errorModal'));
        modal.show();
        document.getElementById('errorModal').addEventListener('hidden.bs.modal', e => e.target.remove());
    }
</script>
</body>
</html>
