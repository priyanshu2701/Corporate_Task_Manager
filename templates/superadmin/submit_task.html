<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>{{ session['user_role'] | capitalize }} - Submit Task</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='assets/css/main.css') }}"
    />

    <style>
      .page-title {
        font-weight: 700;
        color: #1a237e;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f8fafc;
        min-height: 100vh;
      }

      .main-content {
        display: flex;
        min-height: 100vh;
      }

      .content-container {
        flex: 1;
        padding: 40px;
        background: white;
        margin: 20px;
        border-radius: 15px;

        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        animation: fadeIn 0.5s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .section-title {
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e5e7eb;
      }

      .section-title h4 {
        color: #1e40af;
        font-size: 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .table-responsive {
        overflow-x: auto;
        margin-top: 20px;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        color: #212529;
      }

      .table th,
      .table td {
        padding: 12px 15px;
        vertical-align: middle;
        border-top: 1px solid #dee2e6;
      }

      .table thead th {
        border-bottom: 2px solid #dee2e6;
        background-color: #f2f5f9;
        color: #495057;
        font-weight: 600;
        text-align: left;
      }

      .table thead th:first-child,
      .table tbody td:first-child {
        font-weight: bold;
      }

      .table-hover tbody tr:hover {
        background-color: #f0f8ff;
      }

      .status-badge {
        padding: 0.35em 0.8em;
        border-radius: 50px;
        font-size: 0.78rem;
        font-weight: 600;
        text-transform: uppercase;
        border: 1px solid transparent;
      }

      .status-ongoing {
        background-color: #e7f5ff;
        color: #1c7ed6;
        border-color: #a5d8ff;
      }
      .status-in-progress {
        background-color: #f3e8ff;
        color: #7048e8;
        border-color: #d0bfff;
      }
      .status-pending {
        background-color: #fff9db;
        color: #f59f00;
        border-color: #ffec99;
      }
      .status-completed {
        background-color: #e6fcf5;
        color: #2f9e44;
        border-color: #96f2d7;
      }
      .status-blocked {
        background-color: #ffe3e3;
        color: #e03131;
        border-color: #ffa8a8;
      }

      .no-projects {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        font-size: 1.1rem;
        background-color: #fdfdfd;
        border-radius: 10px;
        border: 1px dashed #e9ecef;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 8px 16px;
        font-size: 0.875rem;
        font-weight: 600;
        text-decoration: none;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-secondary {
        background-color: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background-color: #5a6268;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(108, 117, 125, 0.4);
      }

      @media (max-width: 768px) {
        .main-content {
          flex-direction: column;
        }
        .content-container {
          margin: 10px;
          padding: 25px 20px;
        }
        .section-title h4 {
          font-size: 1.2rem;
        }
      }
    </style>
  </head>

  <body>
    <div class="main-content">
      {% set submit_route = 'employee_submit_task' if session['user_role'] in
      ['employee','intern'] else 'admin_submit_task' %} {% include
      'sidebar.html' %}
      <div class="content-container">
        <div class="section-title">
          <h4>ðŸ“‹ Submit Your Task ,{{session['username']}} </h4>
        </div>

        <div class="card shadow-sm">
          <div class="card-body">
            <form
              action="{{ url_for(submit_route) }}"
              method="POST"
              enctype="multipart/form-data"
            >
              <!-- Assigned Task Select -->
              <div class="mb-3">
                <label for="assigned_task_id" class="form-label"
                  >Link to Assigned Task (Optional)</label
                >
                <select
                  class="form-select"
                  id="assigned_task_id"
                  name="assigned_task_id"
                >
                  <option value="">None - General Update</option>
                  {% for task in assigned_tasks %}
                  <option
                    value="{{ task.id }}"
                    data-project-id="{{ task.project_id }}"
                    data-project-name="{{ task.project_name }}"
                  >
                    {{ task.task_name }} (Due: {{ task.due_date }})
                  </option>
                  {% endfor %}
                </select>
              </div>

              <!-- Project Section -->
              <div class="mb-3">
                <label for="project_id" class="form-label">Project</label>
                <!-- Hidden input always sent to backend -->
                <input type="hidden" id="project_id" name="project_id" />
                <!-- Displayed project name (readonly) -->
                <input
                  type="text"
                  id="project_name"
                  class="form-control"
                  readonly
                  style="display: none"
                />
                <!-- Manual project dropdown -->
                <select
                  id="project_dropdown"
                  class="form-select"
                  style="display: none"
                >
                  <option value="">Select a project</option>
                  {% for project in projects %}
                  <option value="{{ project.id }}">
                    {{ project.name }}  â€” 
                <span class="status status-{{ project.status|lower|replace(' ', '') }}">
                {{ project.status }} 
                  </option>
                  {% endfor %}
                </select>
              </div>
              <!-- Task Description -->
              <div class="mb-3">
                <label for="task_description" class="form-label">
                  Task Description <span class="text-danger">*</span>
                </label>

                <textarea
                  class="form-control"
                  id="task_description"
                  name="task_description"
                  rows="5"
                ></textarea>

                <small
                  id="task_description_error"
                  class="text-danger"
                  style="display: none"
                >
                  Task Description is required.
                </small>
              </div>

              <!-- Status -->
              <div class="mb-3">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" name="status">
                  <option value="Ongoing">Ongoing</option>
                  <option value="Completed">Completed</option>

                  
                  
                  {#
                  <option value="Pending">Pending</option>
                  <option value="Blocked">Blocked</option>
                  #}
                </select>
              </div>

              <!-- Attachment -->
              <div class="mb-3">
                <label for="attachment" class="form-label"
                  >Attachment (Optional)</label
                >
                <input
                  class="form-control"
                  type="file"
                  id="attachment"
                  name="attachment"
                />
              </div>

              <button class="btn btn-primary w-100 mt-3">Submit Task</button>
            </form>
          </div>
        </div>
      </div>
    </div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const assignedTaskSelect = document.getElementById("assigned_task_id");
    const projectNameInput = document.getElementById("project_name");
    const projectIdInput = document.getElementById("project_id");
    const projectDropdown = document.getElementById("project_dropdown");

    function showProjectDropdown() {
        projectNameInput.style.display = "none";
        projectDropdown.style.display = "block";
        // Clear previous selection
        projectDropdown.value = "";
        projectIdInput.value = ""; // reset hidden input
    }

    function showAutoProject(projectId, projectName) {
        projectNameInput.value = projectName;
        projectIdInput.value = projectId;

        projectNameInput.style.display = "block";
        projectDropdown.style.display = "none";
    }

    assignedTaskSelect.addEventListener("change", function () {
        const option = this.options[this.selectedIndex];
        const projectId = option.getAttribute("data-project-id");
        const projectName = option.getAttribute("data-project-name");

        if (projectId && projectName) {
            showAutoProject(projectId, projectName);
        } else {
            showProjectDropdown();
        }
    });

    // When user selects a manual project, update hidden input
    projectDropdown.addEventListener("change", function() {
        projectIdInput.value = this.value;
    });

    // Default: no task selected â†’ show manual project dropdown
    showProjectDropdown();
});
</script>
    <!-- CKEditor -->
    <script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/ckeditor.js"></script>

    <script>
      let editorInstance;

      ClassicEditor.create(document.querySelector("#task_description"))
        .then((editor) => {
          editorInstance = editor;
        })
        .catch((error) => console.error(error));

      // Validation + Disable Submit Button
      const form = document.querySelector("form");
      const submitBtn = document.querySelector(
        "button[type='submit'], button.btn-primary"
      );

      form.addEventListener("submit", function (e) {
        let content = editorInstance.getData().trim();

        // If empty, stop the submission
        if (!content) {
          e.preventDefault();
          document.getElementById("task_description_error").style.display =
            "block";
          return;
        }

        // Set textarea value for backend
        document.getElementById("task_description").value = content;

        // Disable button to prevent multiple submissions
        submitBtn.disabled = true;
        submitBtn.innerText = "Submitting...";
      });
    </script>
  </body>
</html>
