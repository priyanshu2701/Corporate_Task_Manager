<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SuperAdmin Dashboard - View Tasks</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='./assets/css/main.css') }}"
    />
    <style>
      /* General Body and Layout */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f8fafc;
        min-height: 100vh;
        display: flex;
        overflow-x: hidden;
      }

      /* Main Content Area */
      .main-content {
          flex: 1;
          padding: 0;
          transition: margin-left 0.3s ease;
          margin-left: 280px;
      }

      /* Header */
      .header {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          padding: 1rem 2rem;
          box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
          display: flex;
          justify-content: space-between;
          align-items: center;
          position: sticky;
          top: 0;
          z-index: 100;
          border-bottom-left-radius: 16px;
          border-bottom-right-radius: 16px;
          margin-bottom: 2rem;
      }

      .sidebar-toggle {
          display: none;
          background: none;
          border: none;
          font-size: 1.5rem;
          color: #6366f1;
          cursor: pointer;
          padding: 0.5rem;
          border-radius: 8px;
          transition: background-color 0.2s;
      }

      .sidebar-toggle:hover {
          background-color: rgba(99, 102, 241, 0.1);
      }

      .page-title {
          font-size: 1.5rem;
          font-weight: 700;
          color: #1e293b;
          margin: 0;
          display: flex;
          align-items: center;
          gap: 0.5rem;
      }

      .breadcrumb {
          background: transparent;
          padding: 0;
          margin: 0;
          font-size: 0.875rem;
      }

      .breadcrumb-item + .breadcrumb-item::before {
          content: "›";
          color: #64748b;
      }

      /* Form Container */
      .form-container {
          flex: 1;
           margin: 20px;
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          border-radius: 16px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          border: 1px solid rgba(255, 255, 255, 0.2);
          overflow: hidden;
          
         
          
          background: white;
          border-radius: 15px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);

        
        
        
      }

      .form-section {
          padding: 2rem;
      }

      .section-title-small {
          margin-bottom: 1.5rem;
          padding-bottom: 1rem;
          border-bottom: 2px solid #e2e8f0;
          color: #1e293b;
          font-size: 1.25rem;
          font-weight: 600;
          display: flex;
          align-items: center;
          gap: 0.5rem;
      }

      .section-title-small i {
          color: #6366f1;
      }

      /* Table Styles */
      .table-responsive {
          border-radius: 12px;
          overflow: hidden;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }

      .table {
          margin-bottom: 0;
          background: white;
          width: 100%;
          min-width: 900px;
      }

      .table thead th {
          background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
          color: white;
          font-weight: 600;
          text-transform: uppercase;
          font-size: 0.875rem;
          letter-spacing: 0.05em;
          border: none;
          padding: 1rem 0.75rem;
          position: sticky;
          top: 0;
          z-index: 10;
      }
      
      .table thead th:first-child,
      .table tbody td:first-child {
          font-weight: bold;
      }

      .table tbody tr {
          border-bottom: 1px solid #e2e8f0;
          transition: all 0.2s ease;
      }

      .table tbody tr:hover {
          background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .table tbody td {
          padding: 1rem 0.75rem;
          vertical-align: middle;
          border: none;
          font-size: 0.875rem;
      }

      /* Status Badge Styles */
      .status-badge {
          padding: 0.25rem 0.75rem;
          border-radius: 50px;
          font-size: 0.75rem;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.05em;
      }

      .status-pending { background: #fef3c7; color: #92400e; }
      .status-ongoing { background: #dbeafe; color: #1e40af; }
      .status-in-progress { background: #e0e7ff; color: #5b21b6; }
      .status-completed { background: #d1fae5; color: #065f46; }
      .status-blocked { background: #fee2e2; color: #991b1b; }

      /* Action Buttons */
      .action-buttons {
          display: flex;
          gap: 0.5rem;
          flex-wrap: wrap;
      }

      .btn {
          padding: 0.5rem 1rem;
          font-size: 0.875rem;
          font-weight: 500;
          border-radius: 8px;
          border: none;
          cursor: pointer;
          transition: all 0.2s ease;
          text-decoration: none;
          display: inline-flex;
          align-items: center;
          gap: 0.25rem;
      }

      .btn-primary {
          background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
          color: white;
          box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
      }

      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
      }

      .btn-danger {
          background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
          color: white;
          box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
      }

      .btn-danger:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 16px rgba(239, 68, 68, 0.4);
      }

      .btn-outline-secondary {
          background: transparent;
          color: #6b7280;
          border: 1px solid #d1d5db;
      }

      .btn-outline-secondary:hover {
          background: #f9fafb;
          color: #374151;
      }

      /* Pagination Styles */
      .pagination {
          display: flex;
          justify-content: center;
          padding: 2rem 0 0 0;
          gap: 0.5rem;
          list-style: none; /* Remove list bullets */
      }

      .page-item .page-link {
          padding: 0.75rem 1rem;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
          color: #6b7280;
          text-decoration: none;
          transition: all 0.2s ease;
          font-weight: 500;
      }

      .page-item .page-link:hover {
          background: #f8fafc;
          border-color: #6366f1;
          color: #6366f1;
      }

      .page-item.active .page-link {
          background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
          border-color: #6366f1;
          color: white;
          box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
      }

      .page-item.disabled .page-link {
          background: #f9fafb;
          color: #cbd5e1;
          cursor: not-allowed;
      }
      
      .pagination > .page-item + .page-item::before {
          content: none;
      }

      /* Form Styles within Modal */
      .form-label {
          font-weight: 600;
          color: #374151;
          margin-bottom: 0.5rem;
      }

      .form-control, .form-select {
          border: 1px solid #dee2e6;
          border-radius: 8px;
          padding: 0.75rem 1rem;
          font-size: 0.875rem;
          transition: all 0.2s ease;
          width: 100%;
      }
      
      .form-control {
          text-transform: capitalize;
      }

      .form-control:focus, .form-select:focus {
          border-color: #6366f1;
          box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
          outline: none;
      }

      .form-control:disabled {
          background: #f9fafb;
          color: #6b7280;
      }

      /* Empty State */
      .empty-state {
          text-align: center;
          padding: 3rem 2rem;
          color: #6b7280;
      }

      .empty-state i {
          font-size: 3rem;
          color: #cbd5e1;
          margin-bottom: 1rem;
      }
      
      /* Responsive Design */
      @media (max-width: 768px) {
          body {
              flex-direction: column;
          }
          .sidebar {
              position: fixed;
              top: 0;
              left: -280px;
              height: 100vh;
              width: 280px;
              z-index: 1051; /* Higher than modal backdrop */
              transition: left 0.3s ease;
          }

          .sidebar.active {
              left: 0;
          }

          .mobile-menu-btn {
              display: block;
              position: fixed;
              top: 15px;
              left: 15px;
              z-index: 1052;
          }

          .main-content {
            margin-left: 0;
            padding-top: 60px;
          }

          .form-container {
              margin: 1rem;
              padding: 1.5rem;
              padding-top:40px;
          }

          .form-section {
              padding: 1rem;
          }

          .table-responsive {
              font-size: 0.875rem;
          }

          .table thead {
              display: none;
          }

          .table tbody tr {
              display: block;
              margin-bottom: 1rem;
              border: 1px solid #e2e8f0;
              border-radius: 8px;
              padding: 1rem;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          }

          .table tbody td {
              display: block;
              padding: 0.5rem 0;
              border: none;
              text-align: left;
          }

          .table tbody td:before {
              content: attr(data-label) ": ";
              font-weight: 600;
              color: #374151;
          }

          .action-buttons {
              justify-content: flex-start;
              margin-top: 1rem;
          }

          .pagination {
              flex-wrap: wrap;
              gap: 0.25rem;
          }

          .page-item .page-link {
              padding: 0.5rem 0.75rem;
              font-size: 0.875rem;
          }
      }

      @media (max-width: 480px) {
          .btn {
              padding: 0.5rem 0.75rem;
              font-size: 0.8rem;
          }
      }

      /* Overlay for mobile sidebar */
      .overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1050; /* Below sidebar, above content */
          display: none;
      }

      .overlay.active {
          display: block;
      }

      /* Minimal Bootstrap Modal CSS to avoid conflicts */
      :root {
        --bs-border-color: #dee2e6;
        --bs-border-color-translucent: rgba(0, 0, 0, 0.175);
      }
      .fade { transition: opacity .15s linear; }
      @media (prefers-reduced-motion: reduce) { .fade { transition: none; } }
      .fade:not(.show) { opacity: 0; }
      .modal {
        --bs-modal-zindex: 1055;
        --bs-modal-width: 500px;
        --bs-modal-padding: 1rem;
        --bs-modal-margin: 0.5rem;
        --bs-modal-bg: #fff;
        --bs-modal-border-color: var(--bs-border-color-translucent);
        --bs-modal-border-width: 1px;
        --bs-modal-border-radius: 0.5rem;
        --bs-modal-box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        --bs-modal-header-padding: 1rem 1rem;
        --bs-modal-header-border-color: var(--bs-border-color);
        --bs-modal-title-line-height: 1.5;
        --bs-modal-footer-gap: 0.5rem;
        --bs-modal-footer-border-color: var(--bs-border-color);
        position: fixed;
        top: 0;
        left: 0;
        z-index: var(--bs-modal-zindex);
        display: none;
        width: 100%;
        height: 100%;
        overflow-x: hidden;
        overflow-y: auto;
        outline: 0;
      }
      .modal-dialog {
        position: relative;
        width: auto;
        margin: var(--bs-modal-margin);
        pointer-events: none;
      }
      .modal.fade .modal-dialog {
        transition: transform .3s ease-out;
        transform: translate(0, -50px);
      }
      @media (prefers-reduced-motion: reduce) { .modal.fade .modal-dialog { transition: none; } }
      .modal.show .modal-dialog { transform: none; }
      .modal-dialog-centered {
        display: flex;
        align-items: center;
        min-height: calc(100% - var(--bs-modal-margin) * 2);
      }
      .modal-content {
        position: relative;
        display: flex;
        flex-direction: column;
        width: 100%;
        pointer-events: auto;
        background-color: var(--bs-modal-bg);
        background-clip: padding-box;
        border: var(--bs-modal-border-width) solid var(--bs-modal-border-color);
        border-radius: var(--bs-modal-border-radius);
        outline: 0;
      }
      .modal-backdrop {
        --bs-backdrop-zindex: 1050;
        --bs-backdrop-bg: #000;
        --bs-backdrop-opacity: 0.5;
        position: fixed;
        top: 0;
        left: 0;
        z-index: var(--bs-backdrop-zindex);
        width: 100vw;
        height: 100vh;
        background-color: var(--bs-backdrop-bg);
      }
      .modal-backdrop.fade { opacity: 0; }
      .modal-backdrop.show { opacity: var(--bs-backdrop-opacity); }
      .modal-header {
        display: flex;
        flex-shrink: 0;
        align-items: center;
        justify-content: space-between;
        padding: var(--bs-modal-header-padding);
        border-bottom: 1px solid var(--bs-modal-header-border-color);
        border-top-left-radius: var(--bs-modal-border-radius);
        border-top-right-radius: var(--bs-modal-border-radius);
      }
      .modal-title { margin-bottom: 0; line-height: var(--bs-modal-title-line-height); }
      .modal-body { position: relative; flex: 1 1 auto; padding: 1rem; }
      .modal-footer {
        display: flex;
        flex-wrap: wrap;
        flex-shrink: 0;
        align-items: center;
        justify-content: flex-end;
        padding: 0.75rem;
        border-top: 1px solid var(--bs-modal-footer-border-color);
        border-bottom-right-radius: var(--bs-modal-border-radius);
        border-bottom-left-radius: var(--bs-modal-border-radius);
      }
      .modal-footer > * { margin: 0.25rem; }
      @media (min-width: 576px) {
        .modal-dialog { max-width: var(--bs-modal-width); margin: 1.75rem auto; }
      }
      @media (min-width: 992px) {
        .modal-lg { --bs-modal-width: 800px; }
      }
      .btn-close {
        box-sizing: content-box;
        width: 1em;
        height: 1em;
        padding: .25em .25em;
        color: #000;
        background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M.293.293a1 1 0 0 1 1.414 0L8 6.586 14.293.293a1 1 0 1 1 1.414 1.414L9.414 8l6.293 6.293a1 1 0 0 1-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 0 1-1.414-1.414L6.586 8 .293 1.707a1 1 0 0 1 0-1.414z'/%3e%3c/svg%3e") center/1em auto no-repeat;
        border: 0;
        border-radius: .25rem;
        opacity: .5;
      }
      .btn-close:hover { opacity: .75; }
      .btn-close:focus { outline: 0; box-shadow: 0 0 0 .25rem rgba(13, 110, 253, .25); opacity: 1; }
      .row { display: flex; flex-wrap: wrap; margin-right: -0.75rem; margin-left: -0.75rem; }
      .row > * { flex-shrink: 0; width: 100%; max-width: 100%; padding-right: 0.75rem; padding-left: 0.75rem; }
      @media (min-width: 768px) { .col-md-6 { flex: 0 0 auto; width: 50%; } }
      .mb-3 { margin-bottom: 1rem !important; }
      .me-1 { margin-right: .25rem !important; }
      .me-2 { margin-right: .5rem !important; }
      .text-warning { color: #ffc107 !important; }
      .shadow-lg { box-shadow: 0 1rem 3rem rgba(0,0,0,.175) !important; }

      /* ** UPDATED: Toast Notification Styles for Top Center ** */
      #toast-notification {
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          z-index: 2000;
          display: flex;
          flex-direction: column;
          align-items: center;
      }
      .toast-content {
          background-color: #fff;
          color: #333;
          padding: 15px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          display: flex;
          align-items: center;
          border-left: 5px solid #4CAF50;
          margin-bottom: 10px;
          opacity: 0;
          transform: translateY(-50px);
          transition: all 0.4s ease;
          min-width: 300px;
      }
      .toast-content.show {
          opacity: 1;
          transform: translateY(0);
      }
      .toast-content.success { border-left-color: #28a745; }
      .toast-content.danger { border-left-color: #dc3545; }
      .toast-content.info { border-left-color: #17a2b8; }
      .toast-content i {
          margin-right: 10px;
          font-size: 1.2rem;
      }
      .toast-content.success i { color: #28a745; }
      .toast-content.danger i { color: #dc3545; }
      .toast-content.info i { color: #17a2b8; }
    </style>
  </head>
  <body>
    <!-- ** ADDED: Containers for flashed messages and toasts ** -->
    <div id="flash-messages" style="display: none;">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div data-category="{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
    <div id="toast-notification"></div>

    <div class="overlay" id="overlay"></div>
    
    

    <div class="main-content" id="mainContent">
        {% include 'sidebar.html' %}
        <div class="">
            
        

        <div id="allTasksTable" class="form-container">
            <div class="form-section">
                <h4 class="section-title-small">
                    <i class="fas fa-list"></i>All Assigned Tasks
                </h4>
                
                {% if tasks %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Project</th>
                                <th>Assigned To</th>
                                <th>Role</th>
                                <th>Dept</th>
                                <th>Task Name</th>
                                <th>Date Assigned</th>
                                <th>Time Assigned</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in tasks %}
                            <tr>
                                <td data-label="Project">{{ task.project if task.project else '—' }}</td>
                                <td data-label="Assigned To">{{ task.assigned_to_name }}</td>
                                <td data-label="Role">{{ task.role }}</td>
                                <td data-label="Dept">{{ task.department }}</td>
                                <td data-label="Task Name">{{ task.task_name }}</td>
                                <td data-label="Date Assigned">{{ task.assigned_date_formatted }}</td>
                                <td data-label="Time Assigned">{{ task.time_assigned_formatted }}</td>
                                <td data-label="Due Date">{{ task.due_date }}</td>
                                <td data-label="Status">
                                    <span class="status-badge status-{{ (task.status | default('')).lower().replace(' ', '-') }}">
                                        {{ task.status }}
                                    </span>
                                </td>
                                <td data-label="Actions">
                                    <div class="action-buttons">
                                        <button
                                            class="btn btn-primary btn-sm js-edit-task"
                                            data-task-id="{{ task.id }}"
                                            data-task-name="{{ task.task_name }}"
                                            data-task-description="{{ task.task_description }}"
                                            data-task-department="{{ task.department }}"
                                            data-task-due-date="{{ task.due_date | replace('/', '-') }}"
                                            data-task-status="{{ task.status }}"
                                            data-task-project-id="{{ task.project_id or '' }}"
                                            data-task-assigned-to-id="{{ task.assigned_to_user_id }}"
                                        >
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button
                                            class="btn btn-danger btn-sm js-delete-task"
                                            data-task-id="{{ task.id }}"
                                        >
                                            <i class="fas fa-trash-alt"></i> Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <nav aria-label="Page navigation">
                    <ul class="pagination">
                        <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for(endpoint, page=current_page - 1) }}">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>

                        {% set window = 2 %}
                        {% set show_dots = false %}
                        {% for page_num in range(1, total_pages + 1) %}
                            {% if page_num == 1 or page_num == total_pages or (page_num >= current_page - window and page_num <= current_page + window) %}
                                <li class="page-item {% if page_num == current_page %}active{% endif %}">
                                    <a class="page-link" href="{{ url_for(endpoint, page=page_num) }}">{{ page_num }}</a>
                                </li>
                                {% set show_dots = false %}
                            {% elif not show_dots %}
                                <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
                                {% set show_dots = true %}
                            {% endif %}
                        {% endfor %}

                        <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for(endpoint, page=current_page + 1) }}">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h5>No Tasks Found</h5>
                    <p>No tasks have been assigned yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editTaskModalLabel"><i class="fas fa-edit me-2"></i>Edit Task</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="editTaskActualForm" action="/update_task" method="POST">
                <input type="hidden" name="task_id" id="editTaskId">
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="editTaskName" class="form-label">Task Name</label>
                        <input name="task_name" class="form-control" id="editTaskName" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="editTaskDueDate" class="form-label">Due Date</label>
                        <input name="due_date" type="date" class="form-control" id="editTaskDueDate" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="editTaskDescription" class="form-label">Task Description</label>
                    <textarea name="task_description" class="form-control" rows="3" id="editTaskDescription"></textarea>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="editTasdepart" class="form-label">Department</label>
                        <input class="form-control" id="editTasdepart" disabled>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="editAssignedToName" class="form-label">Assigned To</label>
                        <input class="form-control" id="editAssignedToName" readonly disabled>
                        <input type="hidden" name="assigned_to_user_id" id="editAssignedToId">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="editTaskStatus" class="form-label">Status</label>
                        <select name="status" class="form-select" id="editTaskStatus">
                            <option value="Pending">Pending</option>
                            <option value="Ongoing">Ongoing</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                            <option value="Blocked">Blocked</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="editTaskProject" class="form-label">Project (Optional)</label>
                        <select name="project_id" class="form-select" id="editTaskProject">
                            <option value="">Select Project</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}" data-dept="{{ project.department }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i> Cancel
            </button>
            <button type="submit" form="editTaskActualForm" class="btn btn-primary">
                <i class="fas fa-save me-1"></i> Update Task
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- ** UPDATED: JavaScript for Modals and Toasts ** -->
    <script>
        let editTaskModalInstance = null;

        // ** ADDED: Function to show toast notifications **
        function showToast(message, category = 'success') {
            const toastContainer = document.getElementById('toast-notification');
            const cleanMessage = message.includes(' ') ? message.substring(message.indexOf(' ') + 1) : message;

            const toast = document.createElement('div');
            toast.className = `toast-content ${category}`;

            const icon = document.createElement('i');
            icon.className = 'fas';
            if (category === 'success') {
                icon.classList.add('fa-check-circle');
            } else if (category === 'danger') {
                icon.classList.add('fa-times-circle');
            } else {
                icon.classList.add('fa-info-circle');
            }

            const messageSpan = document.createElement('span');
            messageSpan.textContent = cleanMessage;

            toast.appendChild(icon);
            toast.appendChild(messageSpan);
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        }

        function editTask(id, name, description, dueDate, status, projectId, assignedToUserId, department) {

            document.getElementById('editTaskId').value = id;
            document.getElementById('editTaskName').value = name;
            document.getElementById('editTaskDescription').value = description;
            document.getElementById('editTaskDueDate').value = dueDate;
            document.getElementById('editTaskStatus').value = status;
            document.getElementById('editTaskProject').value = projectId || '';
            document.getElementById('editAssignedToId').value = assignedToUserId;
            document.getElementById('editTasdepart').value = department;

            filterProjectsByDepartment(department, projectId);
            
            fetch(`/get_user_name/${assignedToUserId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('editAssignedToName').value = 
                        data.success ? data.user_name : 'Unknown User';
                })
                .catch(error => {
                    console.error('Error fetching user name:', error);
                    document.getElementById('editAssignedToName').value = 'Error fetching user';
                });

            if (editTaskModalInstance) {
                editTaskModalInstance.show();
            }
     

        }

        function deleteTask(taskId) {
            showConfirmationModal('Are you sure you want to delete this task? This action cannot be undone.', function() {
                window.location.href = `/delete_task/${taskId}`;
            });
        }

        function showConfirmationModal(message, callback) {
            const existingModal = document.getElementById('confirmationModal');
            if (existingModal) {
                const modal = bootstrap.Modal.getInstance(existingModal);
                if (modal) {
                    modal.hide();
                }
                existingModal.remove();
            }

            const modalHtml = `
                <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content shadow-lg">
                            <div class="modal-header">
                                <h5 class="modal-title" id="confirmationModalLabel"><i class="fas fa-exclamation-triangle text-warning me-2"></i>Confirm Action</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">${message}</div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            const confirmationModalEl = document.getElementById('confirmationModal');
            const confirmationModal = new bootstrap.Modal(confirmationModalEl);
            
            confirmationModalEl.addEventListener('hidden.bs.modal', function (event) {
                event.target.remove();
            });

            document.getElementById('confirmDeleteBtn').onclick = function() {
                callback();
                confirmationModal.hide();
            };

            confirmationModal.show();
        }

        document.addEventListener('DOMContentLoaded', function() {
           
            // Sidebar toggle functionality
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('overlay');
            
            if (sidebarToggle && sidebar && overlay) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('active');
                });

                overlay.addEventListener('click', function() {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                });
            }
            
            // Initialize the edit task modal instance
            const editModalEl = document.getElementById('editTaskModal');
            if(editModalEl) {
                editTaskModalInstance = new bootstrap.Modal(editModalEl);
            }
            
            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.js-edit-task').forEach(button => {
                button.addEventListener('click', function() {
                    const data = this.dataset;
                    editTask(
                        data.taskId,
                        data.taskName,
                        data.taskDescription,
                        data.taskDueDate,
                        data.taskStatus,
                        data.taskProjectId,
                        data.taskAssignedToId,
                        data.taskDepartment
                    );
                });
            });

            document.querySelectorAll('.js-delete-task').forEach(button => {
                button.addEventListener('click', function() {
                    deleteTask(this.dataset.taskId);
                });
            });

            // ** ADDED: Display flashed messages as toasts on page load **
            const flashMessages = document.querySelectorAll('#flash-messages div');
            flashMessages.forEach(flash => {
                const message = flash.textContent;
                const category = flash.dataset.category;
                showToast(message, category);
            });
        });
    </script>
    <script>
    function filterProjectsByDepartment(department, selectedProjectId = '') {
        const projectSelect = document.getElementById('editTaskProject');
        const options = projectSelect.querySelectorAll('option');

        projectSelect.value = ''; // reset

        options.forEach(option => {
            const optDept = option.dataset.dept;

            // Always show "Select Project"
            if (!optDept) {
                option.hidden = false;
                return;
            }

            if (optDept === department) {
                option.hidden = false;
            } else {
                option.hidden = true;
            }
        });

        // Re-select project if exists
        if (selectedProjectId) {
            projectSelect.value = selectedProjectId;
        }
    }
    </script>
  </body>
</html>
